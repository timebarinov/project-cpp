# Транспортный справочник, часть G. Базовая карта автобусов

### Условие

В этой части вам понадобится построить первую версию карты автобусных маршрутов в формате SVG. Карта должна выводиться в ответ на новый запрос к базе — Map:

    "stat_requests": [
    /* ... */
    {
        "id": 999,
        "type": "Map"
    }
    ]

Ответ на запрос Map содержит единственный ключ "map" с SVG-документом:  

    {
    "map": "<?xml version=\"1.0\" encoding=\"UTF-8\" ?><svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"></svg>"
    }

Обратите внимание на необходимость экранирования спецсимволов при выводе строк в JSON: кавычки " и бекслеша \  

**Расширение используемого подмножества формата SVG**

Для построения карты достаточно библиотеки из части F, за одним исключением: цвет может задаваться не только строкой или в формате RGB, но и в формате RGBA (RGB с альфа-каналом): rgba(red,green,blue,alpha) (см. примеры). Альфа-канал сравнивается с правильным с абсолютной погрешностью 1e-6.

Вы не обязаны использовать библиотеку из предыдущей части. Тем не менее, к итоговому SVG-документу выдвигаются прежние требования.

### Настройки отрисовки

Во входных данных добавляется новый ключ — "render_settings", значение которого — словарь, задающий настройки отрисовки.

Ключ | Описание | Формат значения | Гарантии
:-- | :--: | :--: | :--: 
width | Максимальная ширина карты | Вещественное число | Больше 0 и не больше 100000
height | Максимальная высота карты | Вещественное число | Больше 0 и не больше 100000
padding | Отступ от краёв карты | Вещественное число | Не меньше 0 и меньше min(width, height) / 2
stop_radius | Радиус круга остановки | Вещественное число | Больше 0 и не больше 100000
line_width | Толщина линий маршрутов | Вещественное число | Больше 0 и не больше 100000
stop_label_font_size | Размер шрифта названий остановок | Целое число | Больше 0 и не больше 100000
stop_label_offset | Смещение названий остановок | Точка (массив из 2 вещественных чисел) | Не меньше -100000 и не больше 100000
underlayer_color | Цвет подложки под надписями | Цвет | См. ниже
underlayer_width | Толщина линий подложки под надписями | Вещественное число | Больше 0 и не больше 100000
color_palette | Палитра цветов маршрутов | Массив цветов | Непустой массив валидных цветов (см. ниже) длины не более 100


Подробно сценарий использования каждого свойства описан ниже.  

**Описание цвета в JSON**

В значениях свойств underlayer_color и color_palette задаются цвета.

* Строковое значение цвета задаётся непосредственно строкой: "green". В этом случае гарантируется, что эта строка непуста, содержит только строчные латинские буквы и имеет длину не более 20.

* RGB-значение задаётся массивом трёх целых чисел: [0, 255, 0]. В этом случае гарантируется, что все числа принадлежат диапазону [0, 255].

* RGBA-значение задаётся массивом из трёх целых чисел и одного вещественного: [0, 255, 0, 0.5]. В этом случае гарантируется, что первые три числа принадлежат диапазону [0, 255], а четвёртое — диапазону [0, 1].

Гарантируется, что каждый цвет задан с помощью одного из трёх форматов.

**Алгоритм отрисовки**

Чтобы вашу программу можно было автоматически проверить, необходимо в точности соблюдать порядок отрисовки объектов и алгоритм проекции остановок на плоскую карту.

Карта состоит из объектов трёх типов, выводимых в следующем порядке:

1. Линии (ломаные) автобусных маршрутов.

2. Круги, обозначающие остановки.

3. Названия остановок.

Свойства SVG-объектов, не упомянутые ниже, должны иметь те же значения по умолчанию, что и в части F.

**Проекция координат на карту**

Одна из основных задач при рисовании карты — по координатам ключевых точек (в данном случае это автобусные остановки) на земной поверхности определить их координаты на карте (Svg::Point). Для кастомизации этого алгоритма используются три настройки отрисовки: width, height и padding.

Суть дальнейшего алгоритма — использование долгот и широт в качестве координат x и y и их масштабирование для вписания в прямоугольник (width - 2 * padding) × (height - 2 * padding).

Для начала, вычислим минимальные и максимальные значения широт и долгот: min_lat, min_lon, max_lat, max_lon. Дальнейшие преобразования приведут к тому, что остановка с минимальной долготой (longitude) будет иметь минимальную координату x — равную padding; остановка с максимальной широтой (самая северная) будет иметь минимальную координату y, тоже равную padding.

Вычислим максимально допустимый коэффициент масштабирования долгот в иксы: он равен width_zoom_coef = (width - 2 * padding) / (max_lon - min_lon). Аналогично, максимально допустимый коэффициент масштабирования широт в игреки height_zoom_coef = (height - 2 * padding) / (max_lat - min_lat).

Итоговый коэффициент масштабирования (единый для обеих осей) zoom_coef выберем как минимум из width_zoom_coef и height_zoom_coef. Если при вычислении одного из упомянутых выше коэффициентов возникло деление на 0 (из-за того, что все остановки имеют одинаковую широту или одинаковую долготу), в качестве zoom_coef необходимо выбрать другой из двух коэффициентов. Если же все остановки имеют одинаковые координаты, будем считать zoom_coef = 0.

Наконец, получаем следующие формулы вычисления x и y по долготе (lon) и широте (lat):

    x = (lon - min_lon) * zoom_coef + padding;
    y = (max_lat - lat) * zoom_coef + padding;

**Определение цветов автобусов**

Значение настройки color_palette — это цветовая палитра, из которой следует выбирать цвета для автобусных линий. Первый по алфавиту автобус должен получить первый цвет, второй автобус — второй цвет и т. д. Если автобусов оказывается больше, чем цветов палитре, цвета переиспользуются по циклу: например, в случае 10 автобусов и 3 цветов в палитре первый цвет получат 1-й, 4-й, 7-й и 10-й автобусы.

**Отрисовка автобусных маршрутов**

Линии автобусных маршрутов необходимо выводить в порядке возрастания номера (названия) автобуса.

Каждая линия — это ломаная со следующими свойствами:

* Цвет линии (stroke) определён в соответствии с описанными выше правилами.

* Толщина линии (stroke-width) равна настройке line_width.

* Формы конца линии (stroke-linecap) и соединений (stroke-linejoin) равны "round".

Вершины каждой ломаной — это координаты соответствующих остановок. Вершины должны быть выведены в порядке обхода маршрута от первой до первой остановки по кольцевому маршруту: количество вершин должно оказаться равным значению величины stop_count из ответа на запрос Bus. Таким образом, в случае некольцевого маршрута ("is_roundtrip": false) каждый отрезок между соседними остановками будет нарисован дважды.

**Отрисовка кругов остановок**

Круги остановок необходимо выводить в порядке возрастания названия остановки, по одному на каждую остановку, независимо от количества автобусов, проходящих через конкретную остановку.

Круг должен иметь следующие свойства:

* Координаты центра (cx и cy) — координаты соответствующей остановки.

* Радиус (r) равен настройке stop_radius.

* Цвет заливки (fill) — "white".

**Отрисовка названий остановок**

Названия остановок необходимо выводить в порядке возрастания названия остановки, по одному на каждую остановку, независимо от количества автобусов, проходящих через конкретную остановку.

Для каждой остановки необходимо вывести два текстовых объекта: полупрозрачную подложку и саму надпись.

Общие свойства обоих объектов:

* Координаты (x и y) — координаты соответствующей остановки.

* Смещение (dx и dy) равно настройке stop_label_offset.

* Размер шрифта (font-size) равно настройке stop_label_font_size.

* Название шрифта (font-family) — "Verdana".

* Содержимое — собственно название остановки.

Дополнительные свойства подложки:

* Цвет заливки (fill) и цвет линий (stroke) равны настройке underlayer_color.

* Толщина линий (stroke-width) равна настройке underlayer_width.

* Формы конца линии (stroke-linecap) и соединений (stroke-linejoin) равны "round".

Дополнительное свойство самой надписи:

* Цвет заливки (fill) — "black".